<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard MQTT + PZEM + Fuzzy Logic</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
    body { 
        font-family: Arial; 
        background:#0d1117; 
        color:white; 
        text-align:center; 
        padding:20px; 
    }

    .dot { 
        width:15px; 
        height:15px; 
        border-radius:50%; 
        background:red; 
        display:inline-block; 
        margin-right:10px; 
        box-shadow:0 0 10px red; 
    }

    .pzem-card, .relay-card {
        background:#161b22; 
        padding:20px; 
        border-radius:12px; 
        box-shadow:0 0 10px rgba(88,166,255,0.3);
        margin-top:20px;
    }

    .relay-container {
        display:grid; 
        grid-template-columns:repeat(2,1fr); 
        gap:20px; 
        margin-top:20px;
    }

    button { 
        padding:12px 25px; 
        border:none; 
        border-radius:8px; 
        font-weight:bold; 
        margin:5px; 
        cursor:pointer; 
    }

    .on-btn { background:#2ea043; color:white; }
    .off-btn { background:#da3633; color:white; }

    #fuzzy { 
        font-size:25px; 
        margin-top:15px; 
        font-weight:bold; 
    }

    #logBox {
        background:#11161d;
        border-left:4px solid #58a6ff;
        text-align:left;
        margin-top:25px;
        padding:15px;
        height:200px;
        overflow-y:auto;
        font-size:14px;
        border-radius:8px;
    }
</style>
</head>
<body>

<h1>Monitoring PZEM + Fuzzy Logic</h1>

<div>
    <span id="statusDot" class="dot"></span>
    <span id="statusText">MQTT Connecting...</span>
</div>

<div class="pzem-card">
    <h2>Data Sensor</h2>
    <div id="volt">Volt: ---</div>
    <div id="arus">Arus: ---</div>
    <div id="power">Power: ---</div>
    <div id="energy">Energi: ---</div>
    <div id="fuzzy">Konsumsi: ---</div>
</div>

<div class="relay-container">
    <div class="relay-card">
        <h2>Relay 1</h2>
        <button class="on-btn" onclick="sendCmd('ON1')">ON</button>
        <button class="off-btn" onclick="sendCmd('OFF1')">OFF</button>
    </div>

    <div class="relay-card">
        <h2>Relay 2</h2>
        <button class="on-btn" onclick="sendCmd('ON2')">ON</button>
        <button class="off-btn" onclick="sendCmd('OFF2')">OFF</button>
    </div>

    <div class="relay-card">
        <h2>Relay 3</h2>
        <button class="on-btn" onclick="sendCmd('ON3')">ON</button>
        <button class="off-btn" onclick="sendCmd('OFF3')">OFF</button>
    </div>

    <div class="relay-card">
        <h2>Relay 4</h2>
        <button class="on-btn" onclick="sendCmd('ON4')">ON</button>
        <button class="off-btn" onclick="sendCmd('OFF4')">OFF</button>
    </div>
</div>

<h2>Web Serial Monitor</h2>
<div id="logBox"></div>

<script>
// ================= MQTT SETTINGS =================

const clientId = "web-" + Math.random().toString(16).substr(2, 8);
const host = "wss://5ce43b5ff14e439992bf783a9c4fbd58.s1.eu.hivemq.cloud:8884/mqtt";

const options = {
    clientId,
    username: "pudica12",
    password: "Erika145",
    clean: true,
    reconnectPeriod: 3000,
    rejectUnauthorized: false
};

const topicPzem = "pudica/pzem";
const topicCmd  = "pudica/command";

const client = mqtt.connect(host, options);

// UI
const dot   = document.getElementById("statusDot");
const sText = document.getElementById("statusText");
const logBox = document.getElementById("logBox");

// Add line to log
function log(msg) {
    logBox.innerHTML += msg + "<br>";
    logBox.scrollTop = logBox.scrollHeight;
}

// ================= CONNECTED =================

client.on("connect", () => {
    dot.style.background = "#2ea043";
    dot.style.boxShadow = "0 0 10px #2ea043";
    sText.textContent = "Connected!";
    
    log("<span style='color:#2ea043'>[MQTT] Connected to broker</span>");

    client.subscribe(topicPzem, () => {
        log("<span style='color:#58a6ff'>[MQTT] Subscribed to PZEM topic</span>");
    });
});

// ================= ERROR HANDLING =================

client.on("error", (err) => {
    log("<span style='color:red'>[ERROR] MQTT Error: " + err + "</span>");
});

client.on("close", () => {
    dot.style.background = "red";
    sText.textContent = "Disconnected!";
    log("<span style='color:red'>[MQTT] Connection Lost</span>");
});

// ================= RECEIVE MESSAGE =================

client.on("message", (topic, message) => {
    if (topic === topicPzem) {
        const data = JSON.parse(message);

        // Update UI
        document.getElementById("volt").textContent   = "Volt: " + data.volt + " V";
        document.getElementById("arus").textContent   = "Arus: " + data.arus + " A";
        document.getElementById("power").textContent  = "Power: " + data.power + " W";
        document.getElementById("energy").textContent = "Energi: " + data.energy + " Wh";

        const fuzzy = document.getElementById("fuzzy");
        fuzzy.textContent = "Konsumsi: " + data.konsumsi;

        // Warna fuzzy logic
        if (data.konsumsi === "hemat") fuzzy.style.color = "#2ea043";
        else if (data.konsumsi === "sedang") fuzzy.style.color = "#daa520";
        else fuzzy.style.color = "#ff4d4d";

        // Add log
        log("[DATA] Volt=" + data.volt + 
            "  Arus=" + data.arus +
            "  Power=" + data.power +
            "  Energi=" + data.energy +
            "  Fuzzy=" + data.konsumsi);
    }
});

// ================= SEND COMMAND =================

function sendCmd(cmd) {
    client.publish(topicCmd, cmd);
    log("<span style='color:#00eaff'>[CMD] Sent: " + cmd + "</span>");
}
</script>

</body>
</html>
